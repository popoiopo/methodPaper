#+TITLE: Idea for Methodpaper example
#+AUTHOR: Bas Chatel
#+email: bas.chatel@radboudumc.nl
#+LaTeX_CLASS: article
#+LaTeX_CLASS_OPTIONS: [a4paper]
#+LaTeX_HEADER: \usepackage[left=1in,top=1in,right=1in,bottom=1.5in]{geometry}
#+LaTeX_HEADER: \usepackage{palatino}
#+LaTeX_HEADER: \usepackage{sectsty}
#+LaTeX_HEADER: \usepackage{engord}
#+LaTeX_HEADER: \usepackage{cite}
#+LaTeX_HEADER: \usepackage{graphicx}
#+LaTeX_HEADER: \usepackage{setspace}
#+LaTeX_HEADER: \usepackage[compact]{titlesec}
#+LaTeX_HEADER: \usepackage[center]{caption}
#+LaTeX_HEADER: \usepackage{multirow}
#+LaTeX_HEADER: \usepackage{ifthen}
#+LaTeX_HEADER: \usepackage{longtable}
#+LaTeX_HEADER: \usepackage{color}
#+LaTeX_HEADER: \usepackage{listings}
#+LaTeX_HEADER: \usepackage{pdfpages}
#+LaTeX_HEADER: \usepackage{nomencl}	% For glossary
#+LaTeX_HEADER: \usepackage{pdflscape}	% For landscape pictures and environment
#+LaTeX_HEADER: \usepackage{verbatim} 	% For multiline comment environments
#+LaTeX_HEADER: \usepackage[table]{xcolor}
#+LaTeX_HEADER: \usepackage{amssymb,amsmath}
#+LaTeX_HEADER: \usepackage{fancyhdr} %For headers and footers
#+LaTeX_HEADER: \pagestyle{fancy} %For headers and footers
#+LaTeX_HEADER: \usepackage{lastpage} %For getting page x of y
#+LaTeX_HEADER: \usepackage{float} %Allows the figures to be positioned and formatted nicely
#+LaTeX_HEADER: \floatstyle{boxed} %using this
#+LaTeX_HEADER: \restylefloat{figure} %and this command
#+LaTeX_HEADER: \usepackage{url} %Formatting of yrls
#+LaTeX_HEADER: \lhead{Paper example}
#+LaTeX_HEADER: \chead{}
#+LaTeX_HEADER: \rhead{\today}
#+LaTeX_HEADER: \lfoot{Draft}
#+LaTeX_HEADER: \cfoot{}
#+LaTeX_HEADER: \rfoot{\thepage\ of \pageref{LastPage}}
#+OPTIONS: toc:nil num:nil
#+BIND: org-latex-images-centered nil
#+BIND: org-latex-image-default-width "5cm"

* Introduction
Here all modeling steps for turning qualitative knowledge into a quantitative system dynamics model are made concrete using a running example. We will first elaborate on the example problem statement, followed by the goals to be achieved. We will then describe the system, and finally, provide the hypotheses to be answered by modeling.

** Problem
In this example, there is a group of four potato farmers noticing that their potato yield fluctuates significantly over the years. They have all invested in a greenhouse to have more control of the potato growing process. Using their greenhouses, however, they want to know more about the critical factors and how they can best control the environment to optimize potato yield.

** Goal
The farmers want to apply systems thinking to understand more about the dynamics of potato population growth. It is in their best interest to:

1. Keep growth fluctuations low in order to have a steady income.
2. Know what are the best circumstances to grow potatoes in order to optimize yield.
3. Know what is the best timing to harvest.

** System
The farmers use greenhouses where they grow potato plants that need nutrients from the soil (-1.2) and a light source (+1). In the greenhouses, they have full control over the light. The number of potato plants downregulates itself as they compete for space and light (-3). Upon growing, the plants consume nutrients from the soil (-1,2). Furthermore, the ground receives fertilization from a worm population (+4) that eats (-1), and therefore are also drawn to  (+4) the potato plants. However, when the soil is too rich in nutrients, the worm population will decrease as too high levels of nutrients are toxic to the worms (-1). The worms furthermore also have a natural life cycle (i.e., birth (+4) and death (-4)). It is known that there is no causal relationship between the nutrients in the soil and light, just as there is no causal relationship from the worm population to the light source. This system is depicted in figure ref:fig:CLD in the form of an aCLD. Every causal relationship is annotated with its polarity, the intermediate variables, the source of information (a book represents literature and an agent figure represents information obtained from experts with the percentage of consensus between experts), and the functional form (1: Interaction term, 2: Exponential term, 3: Sigmoidal term, 4: Linear term). As we can see in figure ref:fig:CLD, only 25% of the experts think that the warmth of the light can affect the worm population, making this causal relationship hypothetical. Furthermore, both the polarity and functional form of this relationship is not known (??).


#+CAPTION: CLD of scenario
#+NAME: fig:CLD
#+ATTR_LATEX: :width 0.75\linewidth :placement [t]
[[file:network.png]]

** Hypothesis
The amount of light and the number of worms in the soil are the key factors to regulate to lead to a steady and optimized potato yield.

#+LATEX: \clearpage
** Data
The farmers decide to work together and agree to try and grow potatoes under similar conditions except for the strength of light. To keep things fair, they share the potato yield equally, so no single farmer has meager yield during the experiment. They tried to measure their potato population (potatoes per square meter / 10), the nutrient richness of the soil (mg/kg/10), and the number of worms in the ground per square meter daily to provide us with data. This data is presented in figure ref:fig:data with some descriptive statistics in table ref:tab:descr_data.

#+CAPTION: Data of four different greenhouses over 50 time-units. Measurements include strength of light, potato yield, amount of nutrients in the soil, and the number of worm.
#+NAME: fig:data
#+ATTR_LATEX: :width 1\linewidth :placement [h]
[[file:data.png]]

#+CAPTION: Descriptive statistics of data gathered by the farmers.
#+NAME: tab:descr_data
#+ATTR_LATEX: :placement [h]
|               | Greenhouse |    1 |    2 |    3 |    4 |
|---------------+------------+------+------+------+------|
| Potatoes      | Mean       | 0.44 | 0.52 | 0.60 | 0.71 |
|               | Std        | 0.10 | 0.10 | 0.10 | 0.18 |
|               | Min        | 0.18 | 0.30 | 0.39 | 0.30 |
|               | Max        | 0.61 | 0.68 | 0.77 | 0.97 |
|               | Missing    |  60% |  56% |  58% |  62% |
|---------------+------------+------+------+------+------|
| Nutrients     | Mean       | 0.54 | 0.45 | 0.53 | 0.48 |
|               | Std        | 0.10 | 0.09 | 0.09 | 0.06 |
|               | Min        | 0.38 | 0.26 | 0.39 | 0.39 |
|               | Max        | 0.77 | 0.68 | 0.74 | 0.71 |
|               | Missing    |  64% |  54% |  52% |  52% |
|---------------+------------+------+------+------+------|
| Worms         | Mean       | 0.56 | 0.70 | 0.74 | 0.97 |
|               | Std        | 0.11 | 0.12 | 0.17 | 0.20 |
|               | Min        | 0.35 | 0.54 | 0.41 | 0.64 |
|               | Max        | 0.75 | 0.78 | 0.98 | 1.38 |
|               | Missing    |  58% |  60% |  52% |  54% |
|---------------+------------+------+------+------+------|
| Lightstrength |            | 1.25 | 1.50 | 1.75 | 2.00 |

#+LATEX: \clearpage
** Labeling the causal loop diagram

#+CAPTION: Network of scenario
#+NAME: fig:network
#+ATTR_LATEX: :width 1\linewidth :placement [h]
[[file:image.png]]

# In this chapter, we will make all modeling steps concrete by using a running example. In this example, we want to optimize potato yield from a plot of land through simulation of the system. The plot grows potato plants that need nutrients in the soil and a light source. The number of potato plants downregulates itself as they compete for space and light. Upon growing, the plants consume nutrients from the soil.

# Furthermore, the ground receives fertilization from a worm that is drawn to and eats the green leaves from the potato plants. However, when the soil is too rich in nutrients, the worm population will start to decrease as the worms cannot handle this. This system is depicted in figure XXX in the form of a simple CLD.


# * Photohabditus Aminogaster
# ** Funfact
# The Photohabditus Aminogaster is named after two of the most influential animals in genetics, the Caenorhabditis Elegans and the Drosophila Melanogaster.

# ** Introduction of the example
# Imagine a type of worm that is photosensitive for protein expression in protein X. A team of researchers are interested in how light effects not only this protein, but also it's effect on protein Y and Z through the excitatory or inhibitory effects of protein X. The causal diagram is as in figure ref:fig:cdpa. Here we see that protein transcription has a positive relation with light, negative with itself and Y also has a positive relation with X. X has a negative relation with Y, while Z has a positive relation with Y. Y has a negative relation with Z and so does X. In terms of functional forms, the team of experts have knowledge about most links, but not all. The equations are described as follows:

# \begin{align}
#     x  &= x \cdot E_{light}\\
#     dx &= y - x_{u1}\\
#     dy &= -x + \alpha z\\
#     dz &= -y - x_{u2}
# \end{align}

# In the equations above we see that x has an effect of light ($E_{light}$) so that x is multiplied by a value dependent on the absence or presence of light. Furthermore, we can see that there is an $\alpha$ in the equation for $dy$. This is a constant that, just as the effect of light, needs to be fitted in order to find an appropriate value. Lastly, there are two links of which the functional form is unknown or is known with a high degree of uncertainty ($x_{u1}, x_{u2}$). The functional forms of these links also need to be fitted. The rest of the links have a linear relationship.

# The goal of the researchers is to find the model that is responsible for the dynamics of the three proteins. Now that the groundwork for the conceptual model is laid, data is needed to test the model and its uncertainties. Then by testing different possibilities the real underlying system can be retrieved.

# #+CAPTION: Protein transcription causal diagram of Photohabditus Aminogaster.
# #+NAME: fig:cdpa
# #+ATTR_LATEX: :width 0.5\linewidth
# [[file:tiny_model.png]]

# ** The data

# The scientists go on and measure transcription over time of all three proteins while introducing no light (see figure ref:fig:nolightmv) and with light introduction (see figure ref:fig:proteinsmv). The measurement method has introduced some error margin and also around 50% of measurements are missing seem to be missing.
 
# #+BEGIN_center
# #+NAME: fig:nolightmv
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins_no_light_mv.png]]
# #+NAME: fig:proteinsmv
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins_mv.png]]
# #+END_center


# ** Fitting the functional form

# To fit the functional form of a link between two variables one can make use of genetic programming. The idea is to define a set of possible functional forms and apply these to the network in a random way. By doing so, we can sample the possibilities and search for a best fit. In our example, the functional forms for links $x_{u1}$ and $x_{u2}$ are unknown. The set of possible functional forms that we will use is {linear, quadratic, cubic, sigmoid}. These forms are viewed in the following equations in their mathematical form. 

# \begin{align}
# x_u &= x\\
# &= x^2\\
# &= x^3\\
# &= \frac{x}{\sqrt{1 + x^2}}
# \end{align}

# The functional forms can be fitted in several ways. Genetic programming is often used for these types of problems. The idea is to create a population of different answers to the problem and check how well each answer performs. Then the answers are crossbred and mutated due to some selection processes of which the results will be the next generation of population of answers. These will again be evaluated on performance and so on until a predefined number of generations has been hit or the best answer has performed better then some minimal error that is also predefined.

# During each evaluation of a possible functional form, the unknown parameters need to be fitted as well. Here we can, for example, make use of simulated annealing. For simplicity, we will elaborate on the hillclimber algorithm, which is a simpler version of simulated annealing. The idea is that a random value is sampled for a parameter and then the performance is evaluated. Then the value will be nudged a bit in a random direction, and this value will be evaluated for performance as well. If the performance is better, the new value is accepted to be the better solution. Otherwise, if the new value performs worse, it is not accepted. This way, we optimize the parameter value for fitness.

# For example, if we take the following three sets of functional forms:

# $1^{st}$:
# \begin{align}
# x_{u1} &= -x^3\\
# x_{u2} &= -\frac{x}{\sqrt{1 + x^2}}
# \end{align}
# $2^{nd}$:
# \begin{align}
# x_{u1} &= -x\\
# x_{u2} &= -x
# \end{align}
# $3^{rd}$:
# \begin{align}
# x_{u1} &= -\frac{x}{\sqrt{1 + x^2}}\\
# x_{u2} &= -x**3
# \end{align}

# These different forms have different dynamics, but still need to be fitted. In the coming figures we see these networks in the same order with the effect of light equal to the effect of dark ($E_{light}=1$ for both light and dark). Also $\alpha = 1$.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv1_no_fit.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv2_no_fit.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv3_no_fit.png]]
# #+END_center

# With fitting the data we find that the optimal values for the effect of light and $alpha$ are 1 and 0.5 for the first model, 0.7 and 0.7 for the second model and 0.6 and 0.8 for the last model. The cost function chosen here is the mean absolute error that has a value of 0, 0.37 and 0.56 respectively.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv1_hillc_no_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv2_hillc_no_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv3_hillc_no_light.png]]
# #+END_center

# For the dark condition, it seems that the model is as follows: 

# \begin{align}
#     x  &= x \cdot E_{light}\\
#     dx &= y - x^3\\
#     dy &= -x + 0.5z\\
#     dz &= -y - \frac{x}{\sqrt{1 + x^2}}
# \end{align}

# However, we have not yet found the model in the light condition. By applying the same process for the dark condition on all three models we get the following figures.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv1_hillc_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv2_hillc_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv3_hillc_light.png]]
# #+END_center

# Here we find that the optimal values for the light parameter and $\alpha$ are 0.3 and 0.5 for the first model, 0.2 and 0.6 for the second model and 0.0 and 0.8 for the last model. With mean absolute error values 0.0, 0.91, and 1.22 respectively.
# * Final model

# The final model of the system is as follows:

# \begin{align}
#     x  &= x \cdot E_{light}\\
#     dx &= y - x^3\\
#     dy &= -x + 0.5z\\
#     dz &= -y - \frac{x}{\sqrt{1 + x^2}}
# \end{align}

# Where $E_{light}$ is either 1 when the lights are off, and 0.3 when they are on. Running this model provides us with the closest approximation of the data, see figures TODO.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins_no_light.png]]
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins.png]]
# #+END_center

