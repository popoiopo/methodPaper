#+TITLE: Idea for Methodpaper example
#+AUTHOR: Bas Chatel
#+email: bas.chatel@radboudumc.nl
#+LaTeX_CLASS: article
#+LaTeX_CLASS_OPTIONS: [a4paper]
#+LaTeX_HEADER: \usepackage[left=1in,top=1in,right=1in,bottom=1.5in]{geometry}
#+LaTeX_HEADER: \usepackage{palatino}
#+LaTeX_HEADER: \usepackage{sectsty}
#+LaTeX_HEADER: \usepackage{engord}
#+LaTeX_HEADER: \usepackage{cite}
#+LaTeX_HEADER: \usepackage{graphicx}
#+LaTeX_HEADER: \usepackage{setspace}
#+LaTeX_HEADER: \usepackage[compact]{titlesec}
#+LaTeX_HEADER: \usepackage[center]{caption}
#+LaTeX_HEADER: \usepackage{multirow}
#+LaTeX_HEADER: \usepackage{ifthen}
#+LaTeX_HEADER: \usepackage{longtable}
#+LaTeX_HEADER: \usepackage{color}
#+LaTeX_HEADER: \usepackage{listings}
#+LaTeX_HEADER: \usepackage{pdfpages}
#+LaTeX_HEADER: \usepackage{nomencl}	% For glossary
#+LaTeX_HEADER: \usepackage{pdflscape}	% For landscape pictures and environment
#+LaTeX_HEADER: \usepackage{verbatim} 	% For multiline comment environments
#+LaTeX_HEADER: \usepackage[table]{xcolor}
#+LaTeX_HEADER: \usepackage{amssymb,amsmath}
#+LaTeX_HEADER: \usepackage{fancyhdr} %For headers and footers
#+LaTeX_HEADER: \pagestyle{fancy} %For headers and footers
#+LaTeX_HEADER: \usepackage{lastpage} %For getting page x of y
#+LaTeX_HEADER: \usepackage{float} %Allows the figures to be positioned and formatted nicely
#+LaTeX_HEADER: \floatstyle{boxed} %using this
#+LaTeX_HEADER: \restylefloat{figure} %and this command
#+LaTeX_HEADER: \usepackage{url} %Formatting of yrls
#+LaTeX_HEADER: \lhead{Paper example}
#+LaTeX_HEADER: \chead{}
#+LaTeX_HEADER: \rhead{\today}
#+LaTeX_HEADER: \lfoot{Draft}
#+LaTeX_HEADER: \cfoot{}
#+LaTeX_HEADER: \rfoot{\thepage\ of \pageref{LastPage}}
#+OPTIONS: toc:nil num:nil
#+BIND: org-latex-images-centered nil
#+BIND: org-latex-image-default-width "5cm"

* Introduction
Here all modeling steps for turning qualitative knowledge into a quantitative system dynamics model are made concrete using a running example. We will first elaborate on the example problem statement, followed by the goals to be achieved. We will then describe the system, and finally, provide the hypotheses to be answered by modeling.

* Problem
In this example, there is a group of four potato farmers noticing that their potato yield fluctuates significantly over the years. They have all invested in a greenhouse to have more control of the potato growing process. Using their greenhouses, however, they want to know more about the critical factors and how they can best control the environment to optimize potato yield.

* Goal
The farmers want to apply systems thinking to understand more about the dynamics of potato population growth. It is in their best interest to:

1. Keep growth fluctuations low in order to have a steady income.
2. Know what are the best circumstances to grow potatoes in order to optimize yield.
3. Know what is the best timing to harvest.

* System
The farmers use greenhouses where they grow potato plants that need nutrients from the soil (-1.2) and a light source (+1). In the greenhouses, they have full control over the light. The number of potato plants downregulates itself as they compete for space and light (-3). Upon growing, the plants consume nutrients from the soil (-1,2). Furthermore, the ground receives fertilization from a worm population (+4) that eats (-1), and therefore are also drawn to  (+4) the potato plants. However, when the soil is too rich in nutrients, the worm population will decrease as too high levels of nutrients are toxic to the worms (-1). The worms furthermore also have a natural life cycle (i.e., birth (+4) and death (-4)). It is known that there is no causal relationship between the nutrients in the soil and light, just as there is no causal relationship from the worm population to the light source. This system is depicted in figure ref:fig:CLD in the form of an aCLD. Every causal relationship is annotated with its polarity, the intermediate variables, the source of information (a book represents literature and an agent figure represents information obtained from experts with the percentage of consensus between experts), and the functional form (1: Interaction term, 2: Exponential term, 3: Sigmoidal term, 4: Linear term). As we can see in figure ref:fig:CLD, only 25% of the experts think that the warmth of the light can affect the worm population, making this causal relationship hypothetical. Furthermore, both the polarity and functional form of this relationship is not known (??).


#+CAPTION: CLD of scenario
#+NAME: fig:CLD
#+ATTR_LATEX: :width 0.75\linewidth :placement [t]
[[file:network.png]]

* Hypothesis
The amount of light and the number of worms in the soil are the key factors to regulate to lead to a steady and optimized potato yield.

#+LATEX: \clearpage

* Data
The farmers decide to work together and agree to try and grow potatoes under similar conditions except for the strength of light. To keep things fair, they share the potato yield equally, so no single farmer has meager yield during the experiment. They tried to measure their potato population (potatoes per square meter), the nutrient richness of the soil (mg/kg), and the number of worms in the ground per square meter daily to provide us with data that covers all variables in the system as defined in section 3a. The measurements are taken daily for 50 consecutive days, though the farmers have missed quite a few of these measurements which leads us to an average of 60% missing values. This data is presented in figure ref:fig:data with some descriptive statistics in table ref:tab:descr_data.


#+CAPTION: Data of four different greenhouses over 50 time-units. Measurements include strength of light, potato yield, amount of nutrients in the soil, and the number of worm.
#+NAME: fig:data
#+ATTR_LATEX: :width 1\linewidth :placement [h]
[[file:4farmers.png]]

#+CAPTION: Descriptive statistics of data gathered by the farmers.
#+NAME: tab:descr_data
#+ATTR_LATEX: :width 1\linewidth :placement [h]
[[file:dataTable.png]]

#+LATEX: \clearpage

* Labeling the causal loop diagram

Labeling the aCLD revolves around identifying the types of variables. In our system, the variables of interest entail the number of potatoes, the soil nutrients, and the worm population size. These variables are measured over time and, for our purposes, roughly operate on the same timescale. As such, these three variables are stocks in our system. As for the flows, each stock has an inflow and an outflow. 
Firstly, for potatoes, the in-flow represents the population growth rate that is defined as the effect of nutrient intake and photosynthesis. The outflow is the potato yield determined by the combined impact of self-competition and the worms eating the potatoes. 
Secondly, for the worm population, the in-flow is represented by the rate at which new worms are coming into the population through birth and immigration (i.e., consisting of attraction to food and, possibly, the warmth provided by the lights). Light can be seen as an auxiliary, able to change in a short amount of time, as the farmers have full control over its intensity. Conversely, the outflow is represented by the rate at which worms leave the population through death (i.e., natural death or caused by toxicity of the soil nutrients) and emigration. Birth and natural mortality are constant as their natural rhythm does not change within a meaningful interval in the context of our use-case. 
Lastly, for the soil nutrients, the in-flow is represented as the rate at which nutrient concentrations are restored through defecation of worms. The nutrient consumption by the potatoes represents its outflow.


#+CAPTION: Network of scenario
#+NAME: fig:network
#+ATTR_LATEX: :width 1\linewidth :placement [h]
#+ATTR_ORG: :width 200
[[file:nak_sf2.png]]

* Equations

Now that the blueprint of the model has been defined, it is time to turn the conceptual model into a computational model. The resulting SDM consists of a set of equations that drive the model. Although SDMs can have probabilistic components (Sterman, 2018), we will focus on implementing a set of difference equations based on the stock and flow diagram. These visually convey intuition better regarding the passing of time as opposed to differential equations. 

It is good to realize that each causal relation, or set of interacting causal relationships (i.e., interaction terms), represents a term in a difference equation. Each difference equation represents a stock changing over time. To determine the functional form of the hypothetical, or unknown, relationships defined in the CLD, one can use several methods being described in section 2fiv. However, suppose the functional form cannot be found through these methods. In that case, it can be approached as an optimization problem, which means that these unknown terms need to be found (fitted) through the use of model selection methods. 

Another important aspect is that parameters accompany each term. Intuitively, these parameters entail a certain weight to the relationship (e.g., light intensity might exert a much more significant effect on potato growth than nutrient uptake from the soil). These parameters, like the functional form, can sometimes be found in literature or found through expert knowledge. However, often they need to be fitted, making it an optimization issue. These optimization methods are covered in more detail in section XXX.

To summarize, when all functional forms are determined, the equations can be expressed. Each stock in the system entails a difference equation, while each relation with said stock provides a term. These terms need to be parameterized by defining weights and initial values (Brailsford, 2008). 

Time is managed in discrete steps where the time step, delta t, is chosen on the stocks' level. If delta t is smaller than the temporal scale a particular term operates in, it is multiplied by the ratio to account for this difference. For example, if the simulation operates on a temporal scale of one day, and the term operates on four days, it can be multiplied by 1/4 (Brailsford, 2008).

In calculating the auxiliary variables, the order of updating the values in the system can also affect how these values develop. As these values depend on all the values connecting variables, they are to be updated synchronously. However, in dealing with stocks, the update order occurs asynchronously. This order is essential as they depend on the previous time-step of all connecting variables, and they can also have a logical order. In determining the update order, it is always necessary to place the variables into the context of reality and assess whether the order makes sense (e.g., biologically, physically).

In SDMs, dimensional consistency between the units of the left- and right-hand side of each equation should be preserved to ensure that the model makes sense. Unit consistency can be accomplished partly by picking units for constants intelligently; however, these should still be reasonable (Forrester, 1994).

** Example

In terms of functional forms, the farmers, together with other experts from the agricultural sector, know of most links, but not all. Our case has three stocks in the system; potato population, soil nutrients, and worm population. This means that there is a total of three differential equations that need to be formed, each containing terms from its respective causal relationships. Here we will reason through the terms of the potato stock to gain intuition on how such a system might translate into a system of equations. Then we will provide the entire system based on our knowledge so far.

*** Potatoes

The potatoes stock consists of two terms contributing to the in-flow and two terms contributing to the out-flow. The effect of light and soil nutrients are responsible for the in-flow. Literature tells us both the polarity and functional form of the effect of light as it is an interaction term of potatoes and light where both need to be present. The parameter value is also found in the literature. The fact that this is an "AND" relationship (see section XXX (interaction terms)) makes it likely that the functional form is as follows:

1.5 * p * light

Here 1.5 is the parameter weight that precedes the stock variable value and is provided by the experts. The previous time step is used from the potato stock value times the light value. We do not know, however, the exact functional form of the effect of soil nutrients. The experts have reached a consensus that it must be an exponential interaction term but do not know the exact order of the exponential; this needs to be fitted later on. Given this information, the functional form as far as currently known is as follows:

(1 * s**a_1) * (1 * p)

The self-competition loop as a result of space and light competition only has a known polarity. The experts say it has a negative effect on the potato stock with an unknown parameter and functional form. This results in the following equation:

-(a_2 * f1(p))

The term is negative, but the value of a_2 is unknown, and the functional form (f1) also needs to be fitted at a later time. The potato loss due to worms, however, is entirely known by literature. Much like the influence of light, it is an interaction term that looks as follows:

-(2 * w) * (1. * p)

*** System of equations

 When traversing through the entire system the set of equations (Wordt nog mooier gemaakt aan de hand van waar eindversie in geschreven wordt) are described as follows:

#+BEGIN_SRC python
  p_{t+1} = (1.5 * p) * light + # Influence of light on potato growth
       (1 * s**a_1) * (1 * p) + # Influence of nutrients in the soil on potato growth
       -(a_2 * f1(p)) + # Competition with themselves
       -(2 * w) * (1. * p) # Potato loss due to worms

  s_{t+1} = (0.3 * w) + # Worm contribution by feces to soil nutrients
       -(1 * p**a_3) * (1 * s) + # Soil nutrient consumption from potatoes

  w_{t+1} = (1.2 * p) + # Migration caused by potatoes
       (0.1 * w) + # Worm birth
       -(a_4 * w) + # Worm death
       -(2 * s) * (1 * w) + # Toxic effect of too much nutrients on worm population
       (-|+)(a_5 * f2(w, light)) # Attraction to the warmth of the light
#+END_SRC

* Optimization

If our network was a recipe for delicious bread, the causal relationships are ingredients and parameters the amounts of each ingredient. As the chef, it is our job to find the best recipe and, in each try, improve the recipe. After each try, we taste the result (i.e., our cost function) and assess whether the recipe has improved. Outside of the recipe itself, we also need to assess the settings in the oven; these oven settings map to the hyperparameters of the optimization algorithm. Too high a temperature and the bread bakes too fast, resulting in bread that does not rise. The algorithm converges too fast to a local optimum, and not enough of the parameter space has been sampled. Too low a temperature and the bread will never bake, so we will never reach an optimum. Even though they are not part of the bread itself, these oven settings (i.e., hyperparameters) are an essential part of finding the best recipe as they can influence the result significantly. In this section, we will briefly elaborate on the notions of model selection (choosing the right ingredients), parameter estimation (estimating the right quantities of ingredients),  and that of cost functions (tasting the bread) in light of our example.

In the example, there are five parameters (a_n) and two functions (f_n) to be estimated in the previous section. By assessing the two functions, we are effectively choosing a model that best fits the data (model selection). Whenever a different function is selected, the parameters (a_n) should be optimized for this new configuration. In this example, we will place both processes, optimization of the functional form (i.e., model selection) and optimizing parameter values, in a more practical light.

** Model selection

In our system, there is one function f1() that is unknown and needs to be fitted. In conjunction with the farmers, the experts have narrowed the possible set of functional forms down to two; linear and sigmoidal. Their reasoning for this was that self-competition increases linearly to the number of potatoes, so each added potato increases self-competition in the same way. Alternatively, potatoes barely compete with one another, until a critical point where potatoes start competing for space and light. Around this point, self-competition increases until it reaches an asymptotic maximum.

For f2(), the attraction of worms towards the warmth of the light, the experts, and farmers are unsure whether there is a causal relationship at all. If there is, they do not know its functional form nor its parameter value or polarity. There is considerable uncertainty in this causal relationship, which can be reduced by declaring a broad set of possible functional forms and fitting them. However, this is a computationally challenging process, as each added functional form adds to the model space. By declaring a set of 3 possible functional forms for f2, the combined number of possible configurations to be tested would amount to 10 (the product of the number of possible configurations for each function plus the configuration without the hypothetical edge).

Usually, the set of possible functional forms can be quite bigger, and how to choose and define this set is subject to a variety of nuances. For further details on selecting sets of functional forms, we refer the reader to [[https://link.springer.com/chapter/10.1007/978-3-540-24650-3_18][Wang & Soule (2004)]].

** Parameter estimation

Parameters are not just numbers. It can be seen as a convergence of, for example, the importance of a variable, the absorption of a temporal difference between variables, an effect of unknown intermediate processes, and so forth. By thinking about parameters in such a manner, it also appears natural that a single "true" set of parameters is hard to find, or might not even exist. The parameters can differ slightly over time or can entail uncertainty from our perspective. That is why parameter values are often visualized as a distribution, where its variance relates to a type of uncertainty. For example, the Metropolis-Hastings algorithm is designed to converge towards a distribution that encodes the likelihood of a parameter being a particular value given the data on which we fit the cost function. Such distributions can also estimate the parameters in our example network. Each parameter (a_1 through a_n) has its own distribution where the top represents the maximum likelihood estimation (MLE). The ideas surrounding optimization algorithms and their cost functions still are the same as described earlier.  

** Uncertainty propagation and sensitivity analysis

** Validation: longitudinal (train/test) and cross-sectional data (validation statements)

** Crap

# In this chapter, we will make all modeling steps concrete by using a running example. In this example, we want to optimize potato yield from a plot of land through simulation of the system. The plot grows potato plants that need nutrients in the soil and a light source. The number of potato plants downregulates itself as they compete for space and light. Upon growing, the plants consume nutrients from the soil.

# Furthermore, the ground receives fertilization from a worm that is drawn to and eats the green leaves from the potato plants. However, when the soil is too rich in nutrients, the worm population will start to decrease as the worms cannot handle this. This system is depicted in figure XXX in the form of a simple CLD.


# * Photohabditus Aminogaster
# ** Funfact
# The Photohabditus Aminogaster is named after two of the most influential animals in genetics, the Caenorhabditis Elegans and the Drosophila Melanogaster.

# ** Introduction of the example
# Imagine a type of worm that is photosensitive for protein expression in protein X. A team of researchers are interested in how light effects not only this protein, but also it's effect on protein Y and Z through the excitatory or inhibitory effects of protein X. The causal diagram is as in figure ref:fig:cdpa. Here we see that protein transcription has a positive relation with light, negative with itself and Y also has a positive relation with X. X has a negative relation with Y, while Z has a positive relation with Y. Y has a negative relation with Z and so does X. In terms of functional forms, the team of experts have knowledge about most links, but not all. The equations are described as follows:

# \begin{align}
#     x  &= x \cdot E_{light}\\
#     dx &= y - x_{u1}\\
#     dy &= -x + \alpha z\\
#     dz &= -y - x_{u2}
# \end{align}

# In the equations above we see that x has an effect of light ($E_{light}$) so that x is multiplied by a value dependent on the absence or presence of light. Furthermore, we can see that there is an $\alpha$ in the equation for $dy$. This is a constant that, just as the effect of light, needs to be fitted in order to find an appropriate value. Lastly, there are two links of which the functional form is unknown or is known with a high degree of uncertainty ($x_{u1}, x_{u2}$). The functional forms of these links also need to be fitted. The rest of the links have a linear relationship.

# The goal of the researchers is to find the model that is responsible for the dynamics of the three proteins. Now that the groundwork for the conceptual model is laid, data is needed to test the model and its uncertainties. Then by testing different possibilities the real underlying system can be retrieved.

# #+CAPTION: Protein transcription causal diagram of Photohabditus Aminogaster.
# #+NAME: fig:cdpa
# #+ATTR_LATEX: :width 0.5\linewidth
# [[file:tiny_model.png]]

# ** The data

# The scientists go on and measure transcription over time of all three proteins while introducing no light (see figure ref:fig:nolightmv) and with light introduction (see figure ref:fig:proteinsmv). The measurement method has introduced some error margin and also around 50% of measurements are missing seem to be missing.
 
# #+BEGIN_center
# #+NAME: fig:nolightmv
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins_no_light_mv.png]]
# #+NAME: fig:proteinsmv
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins_mv.png]]
# #+END_center


# ** Fitting the functional form

# To fit the functional form of a link between two variables one can make use of genetic programming. The idea is to define a set of possible functional forms and apply these to the network in a random way. By doing so, we can sample the possibilities and search for a best fit. In our example, the functional forms for links $x_{u1}$ and $x_{u2}$ are unknown. The set of possible functional forms that we will use is {linear, quadratic, cubic, sigmoid}. These forms are viewed in the following equations in their mathematical form. 

# \begin{align}
# x_u &= x\\
# &= x^2\\
# &= x^3\\
# &= \frac{x}{\sqrt{1 + x^2}}
# \end{align}

# The functional forms can be fitted in several ways. Genetic programming is often used for these types of problems. The idea is to create a population of different answers to the problem and check how well each answer performs. Then the answers are crossbred and mutated due to some selection processes of which the results will be the next generation of population of answers. These will again be evaluated on performance and so on until a predefined number of generations has been hit or the best answer has performed better then some minimal error that is also predefined.

# During each evaluation of a possible functional form, the unknown parameters need to be fitted as well. Here we can, for example, make use of simulated annealing. For simplicity, we will elaborate on the hillclimber algorithm, which is a simpler version of simulated annealing. The idea is that a random value is sampled for a parameter and then the performance is evaluated. Then the value will be nudged a bit in a random direction, and this value will be evaluated for performance as well. If the performance is better, the new value is accepted to be the better solution. Otherwise, if the new value performs worse, it is not accepted. This way, we optimize the parameter value for fitness.

# For example, if we take the following three sets of functional forms:

# $1^{st}$:
# \begin{align}
# x_{u1} &= -x^3\\
# x_{u2} &= -\frac{x}{\sqrt{1 + x^2}}
# \end{align}
# $2^{nd}$:
# \begin{align}
# x_{u1} &= -x\\
# x_{u2} &= -x
# \end{align}
# $3^{rd}$:
# \begin{align}
# x_{u1} &= -\frac{x}{\sqrt{1 + x^2}}\\
# x_{u2} &= -x**3
# \end{align}

# These different forms have different dynamics, but still need to be fitted. In the coming figures we see these networks in the same order with the effect of light equal to the effect of dark ($E_{light}=1$ for both light and dark). Also $\alpha = 1$.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv1_no_fit.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv2_no_fit.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv3_no_fit.png]]
# #+END_center

# With fitting the data we find that the optimal values for the effect of light and $alpha$ are 1 and 0.5 for the first model, 0.7 and 0.7 for the second model and 0.6 and 0.8 for the last model. The cost function chosen here is the mean absolute error that has a value of 0, 0.37 and 0.56 respectively.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv1_hillc_no_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv2_hillc_no_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv3_hillc_no_light.png]]
# #+END_center

# For the dark condition, it seems that the model is as follows: 

# \begin{align}
#     x  &= x \cdot E_{light}\\
#     dx &= y - x^3\\
#     dy &= -x + 0.5z\\
#     dz &= -y - \frac{x}{\sqrt{1 + x^2}}
# \end{align}

# However, we have not yet found the model in the light condition. By applying the same process for the dark condition on all three models we get the following figures.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv1_hillc_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv2_hillc_light.png]]
# #+ATTR_LaTeX: :width 0.32\textwidth :center
# [[file:proteins_deriv3_hillc_light.png]]
# #+END_center

# Here we find that the optimal values for the light parameter and $\alpha$ are 0.3 and 0.5 for the first model, 0.2 and 0.6 for the second model and 0.0 and 0.8 for the last model. With mean absolute error values 0.0, 0.91, and 1.22 respectively.
# * Final model

# The final model of the system is as follows:

# \begin{align}
#     x  &= x \cdot E_{light}\\
#     dx &= y - x^3\\
#     dy &= -x + 0.5z\\
#     dz &= -y - \frac{x}{\sqrt{1 + x^2}}
# \end{align}

# Where $E_{light}$ is either 1 when the lights are off, and 0.3 when they are on. Running this model provides us with the closest approximation of the data, see figures TODO.

# #+BEGIN_center
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins_no_light.png]]
# #+ATTR_LaTeX: :width 0.49\textwidth :center
# [[file:proteins.png]]
# #+END_center
** Questions

